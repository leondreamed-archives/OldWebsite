**Warning: Ugly PHP code ahead**

Refractor to Javascript (or maybe Ruby on Rails) planned :)
